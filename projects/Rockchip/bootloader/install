# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2022-24 JELOS (https://github.com/JustEnoughLinuxOS)
# Copyright (C) 2024-present ROCKNIX (https://github.com/ROCKNIX)

PKG_RKBIN="$(get_build_dir rkbin)"
PKG_UBOOT="$(get_build_dir u-boot)"
source ${PROJECT_DIR}/${PROJECT}/devices/${DEVICE}/options

if [ -n "${PKG_DATAFILE}" -a -n "${PKG_LOADER}" ]; then
  echo "loader: Make idbloader.img from ${PKG_DATAFILE}:${PKG_LOADER}..."
  case "${PKG_SOC}" in
    rk3399)
      ${PKG_RKBIN}/tools/mkimage -n "${PKG_SOC}" -T rksd -d ${PKG_DATAFILE}:${PKG_LOADER} idbloader.img.rk || exit 1
      ;;
  esac
fi

if [ ! -n "${PKG_LOAD_ADDR}" ]; then
  PKG_LOAD_ADDR="0x00200000"
fi

case "${PKG_SOC}" in
  rk3399)
    PKG_ATF_INI="${PKG_RKBIN}"/RKTRUST/"${DEVICE}"TRUST.ini
    echo "uboot: building ${UBOOT_FIT_IMAGE}..."
    ${PKG_RKBIN}/tools/loaderimage --pack --uboot u-boot-dtb.bin u-boot.img.rk "${PKG_LOAD_ADDR}" || exit 1
    dd if=idbloader.img.rk of="${UBOOT_FIT_IMAGE}" seek=0 conv=fsync,notrunc > /dev/null 2>&1 || exit 1
    dd if=u-boot.img.rk of="${UBOOT_FIT_IMAGE}" seek=16320 conv=fsync,notrunc > /dev/null 2>&1 || exit 1
    "${PKG_RKBIN}"/tools/trust_merger --ignore-bl32 --prepath "${PKG_RKBIN}"/ "${PKG_ATF_INI}" || exit 1
    dd if=trust.img of="${UBOOT_FIT_IMAGE}" seek=24512 conv=fsync,notrunc > /dev/null 2>&1 || exit 1
  
    echo "uboot: copy ${UBOOT_FIT_IMAGE} to ${INSTALL}/usr/share/bootloader..."
    cp -av ${UBOOT_FIT_IMAGE} ${INSTALL}/usr/share/bootloader
    ;;
esac
