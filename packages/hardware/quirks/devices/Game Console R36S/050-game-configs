#!/bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2022-present JELOS (https://github.com/JustEnoughLinuxOS)

. /etc/profile

#Set mupen64-plus-sa config for R36S, can use same profile as OGS
if [ ! -d "/storage/.config/mupen64plus" ]; then
    mkdir -p "/storage/.config/mupen64plus/"
        cp -r /usr/local/share/mupen64plus/mupen64plus.cfg* /storage/.config/mupen64plus/
fi
if [ -f "/storage/.config/mupen64plus/mupen64plus.cfg.ogs" ]; then
  rm /storage/.config/mupen64plus/mupen64plus.cfg
  mv /storage/.config/mupen64plus/mupen64plus.cfg.ogs /storage/.config/mupen64plus/mupen64plus.cfg
fi

#Set drastic-sa config for R36S (think it can use the same as RG20S)
if [ ! -d "/storage/.config/drastic" ]; then
    mkdir -p "/storage/.config/drastic"
        cp -r "/usr/config/drastic" "/storage/.config/"
fi
if [ -f "/storage/.config/drastic/config/drastic.cfg.rgb20s" ]; then
  rm /storage/.config/drastic/config/drastic.cfg
  mv /storage/.config/drastic/config/drastic.cfg.rgb20s /storage/.config/drastic/config/drastic.cfg
fi

#Map ppsspp controls
if  grep R36S -q "/storage/.config/ppsspp/PSP/SYSTEM/controls.ini"
then
  exit 1
else
cat <<EOF >/storage/.config/ppsspp/PSP/SYSTEM/controls.ini
#R36S
[ControlMapping]
Up = 10-19
Down = 10-20
Left = 10-21
Right = 10-22
Circle = 10-189
Cross = 10-190
Square = 10-188
Triangle = 10-191
Start = 10-197
Select = 10-196
L = 10-193
R = 10-192
An.Up = 10-4003
An.Down = 10-4002
An.Left = 10-4001
An.Right = 10-4000
Pause = 10-106
Save State = 10-4010
Load State = 10-4008
RightAn.Up = 10-4007
RightAn.Down = 10-4006
RightAn.Left = 10-4005
RightAn.Right = 10-4004
EOF
fi

# Remove the line containing odroidgo3_joypad and replace it with R36 mapping.
FILE="/storage/.config/SDL-GameControllerDB/gamecontrollerdb.txt"
if [ -f ${FILE} ]; then
    rm ${FILE}
    cp -f /usr/config/SDL-GameControllerDB/gamecontrollerdb.txt ${FILE}
    sed -i '/odroidgo3_joypad/d' ${FILE} 
    echo '1900c3ea010000000100000001010000,odroidgo3_joypad,a:b1,b:b0,dpdown:b14,dpleft:b15,+lefty:+a1,-leftx:-a0,+leftx:+a0,-lefty:-a1,leftshoulder:b4,leftstick:b11,lefttrigger:b6,dpright:b16,+righty:+a3,-rightx:-a2,+rightx:+a2,-righty:-a3,rightshoulder:b5,rightstick:b12,righttrigger:b7,back:b8,start:b9,dpup:b13,x:b2,y:b3,platform:Linux,' >>${FILE}
fi
